version: 2

aliases:
  - &restore_cache
    keys:
      - cargo-{{ checksum "Cargo.toml" }}
      - cargo-

  - &save_cache
    key: cargo-{{ checksum "Cargo.toml" }}
    paths:
      - target
      - fixture_setup/target
      - ~/.cargo

jobs:
  lint:
    docker:
      - image: 0xcaff/rust-nightly

    steps:
      - checkout

      - restore_cache: *restore_cache

      - run:
          name: Check for Errors
          command: |
            cargo check
            cd fixture_setup
            cargo check

      - save_cache: *save_cache

      - run:
          name: Check Formatting
          command: |
            cargo fmt -- --write-mode=diff
            cd fixture_setup
            cargo fmt -- --write-mode=diff

      - run:
          name: Check Linting
          command: |
            cargo clippy -- -D warnings
            cd fixture_setup
            cargo clippy -- -D warnings

      - save_cache: *save_cache

  test:
    docker:
      # Primary container
      - image: 0xcaff/rust-nightly

      # Secondary container (available on localhost)
      - image: redis:4.0.6

    steps:
      - checkout

      - restore_cache: *restore_cache

      - run:
          name: Install Fixtures
          command: |
            cd fixture_setup
            cargo run

      - run:
          name: Start Core
          # Start core as a daemon logging to server.log
          command: cargo run >server.log 2>&1 &

      # TODO: Run tests

      # Don't save the cache (use the cache generated by lint)

workflows:
  version: 2
  test:
    jobs:
      - lint
      - test
